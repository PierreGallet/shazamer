name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:github-action

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          # Extract host and port
          HOST=$(echo "$SSH_HOST" | cut -d':' -f1)
          PORT=$(echo "$SSH_HOST" | grep -o ':[0-9]*' | cut -d':' -f2 || echo "22")
          ssh-keyscan -H -p $PORT $HOST >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |

          # Create deployment script
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "ðŸš€ Starting deployment of Shazamer..."

          # Navigate to deployment directory
          cd "$DEPLOY_PATH" || {
            echo "Creating deployment directory..."
            mkdir -p "$DEPLOY_PATH"
            cd "$DEPLOY_PATH"
          }

          # Clone or update repository
          if [ -d ".git" ]; then
            echo "ðŸ“¥ Updating existing repository..."
            git fetch origin
            git reset --hard origin/main
          else
            echo "ðŸ“¥ Cloning repository..."
            git clone https://github.com/PierreGallet/shazamer.git .
          fi

          # Stop existing containers (only shazamer project)
          echo "ðŸ›‘ Stopping existing containers..."
          docker compose down || true

          # Build and start new containers
          echo "ðŸ—ï¸ Building Docker images..."
          docker compose build --no-cache

          echo "ðŸš€ Starting containers..."
          docker compose up -d

          # Wait for health checks
          echo "â³ Waiting for services to be healthy..."
          sleep 10

          # Check if services are running
          if docker compose ps | grep -q "Up"; then
            echo "âœ… Deployment successful!"
            docker compose ps
          else
            echo "âŒ Deployment failed! Services are not running."
            docker compose logs
            exit 1
          fi

          # Cleanup old images
          echo "ðŸ§¹ Cleaning up old Docker images..."
          docker image prune -f


          echo "âœ¨ Deployment completed successfully!"
          EOF

          # Copy and execute deployment script
          HOST=$(echo $SSH_HOST | cut -d':' -f1)
          PORT=$(echo $SSH_HOST | grep -o ':[0-9]*' | cut -d':' -f2 || echo "22")

          # Set environment variables for the script
          export DEPLOY_PATH

          # Execute deployment script on remote server
          scp -P $PORT deploy.sh $SSH_USER@$HOST:/tmp/deploy.sh
          ssh -p $PORT $SSH_USER@$HOST "DEPLOY_PATH='$DEPLOY_PATH' bash /tmp/deploy.sh && rm /tmp/deploy.sh"

          # Cleanup
          rm deploy.sh

      - name: Health check
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          HOST=$(echo $SSH_HOST | cut -d':' -f1)
          PORT=$(echo $SSH_HOST | grep -o ':[0-9]*' | cut -d':' -f2 || echo "22")

          echo "ðŸ¥ Running health checks..."

          # Check if containers are running
          ssh -p $PORT $SSH_USER@$HOST "cd $DEPLOY_PATH && docker compose ps"

          # Wait for services to be healthy
          sleep 10

          # Check HTTP endpoint
          if ssh -p $PORT $SSH_USER@$HOST "curl -f -s -o /dev/null http://localhost:8082/"; then
            echo "âœ… Health check passed!"
          else
            echo "âŒ Health check failed!"
            ssh -p $PORT $SSH_USER@$HOST "cd $DEPLOY_PATH && docker compose logs --tail 50"
            exit 1
          fi

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment to shazamer.pierregallet.com completed successfully!"
          else
            echo "âŒ Deployment failed! Check the logs for more information."
          fi
